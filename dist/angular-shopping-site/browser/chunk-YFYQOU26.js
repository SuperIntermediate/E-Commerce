import{Eb as d,Fb as h,O as U,a as l,b as u,ea as c}from"./chunk-HE5TQUO2.js";function g(m){let s={alg:"none",typ:"JWT"},e=r=>btoa(JSON.stringify(r));return`${e(s)}.${e(m)}.${e("signature")}`}var y="ng_ecommerce_auth_v1",p="ng_ecommerce_users_v1",f=class m{token=c(null);user=c(null);usersByEmail=c({});isAuthenticated=d(()=>!!this.token());isAdmin=d(()=>this.user()?.role==="admin");isSeller=d(()=>this.user()?.role==="seller");constructor(){try{let s=localStorage.getItem(y);if(s){let e=JSON.parse(s);this.token.set(e?.token??null),this.user.set(e?.user??null)}}catch{}try{let s=localStorage.getItem(p),e={};s&&(e=JSON.parse(s)||{});let r={};for(let[i,t]of Object.entries(e))r[i]=u(l({},t),{role:t.role??"customer"});if(Object.keys(r).length===0){let i="admin@example.com";r[i]={id:"U-admin",name:"Admin",email:i,password:"admin",role:"admin"};let t="seller@example.com";r[t]={id:"U-seller",name:"Seller",email:t,password:"seller",role:"seller"}}this.usersByEmail.set(r)}catch{}h(()=>{let s={token:this.token(),user:this.user()};try{localStorage.setItem(y,JSON.stringify(s))}catch{}}),h(()=>{let s=this.usersByEmail();try{localStorage.setItem(p,JSON.stringify(s))}catch{}})}normalize(s){return s.trim().toLowerCase()}hasUser(s){let e=this.normalize(s);return!!this.usersByEmail()[e]}login({email:s,password:e}){if(!s||!e)throw new Error("Email and password are required");let r=this.normalize(s),t=this.usersByEmail()[r];if(!t)throw new Error("NO_ACCOUNT");if(t.password!==e)throw new Error("BAD_CREDENTIALS");let n=t.role??"customer",o={id:t.id,name:t.name,email:t.email,role:n},a=g({sub:o.id,email:o.email,name:o.name,role:n});return this.user.set(o),this.token.set(a),o}signup({name:s,email:e,password:r,role:i}){if(!s||!e||!r)throw new Error("Name, email, and password are required");let t=this.normalize(e),n=l({},this.usersByEmail());if(n[t])throw new Error("ACCOUNT_EXISTS");let o={id:`U-${Date.now()}`,name:s.trim(),email:t,password:r,role:i??"customer"};n[t]=o,this.usersByEmail.set(n);let a={id:o.id,name:o.name,email:o.email,role:o.role},E=g({sub:a.id,email:a.email,name:a.name,role:a.role});return this.user.set(a),this.token.set(E),a}logout(){this.user.set(null),this.token.set(null)}getRegisteredUsers(){return Object.values(this.usersByEmail()).sort((s,e)=>s.email.localeCompare(e.email))}updateUserRole(s,e){let r=this.normalize(s),i=l({},this.usersByEmail()),t=i[r];if(!t)throw new Error("NO_ACCOUNT");i[r]=u(l({},t),{role:e}),this.usersByEmail.set(i);let n=this.user();if(n&&this.normalize(n.email)===r){this.user.set(u(l({},n),{role:e}));let o=g({sub:n.id,email:n.email,name:n.name,role:e});this.token.set(o)}}deleteUser(s){let e=this.normalize(s),r=l({},this.usersByEmail());if(!r[e])throw new Error("NO_ACCOUNT");delete r[e],this.usersByEmail.set(r);let i=this.user();i&&this.normalize(i.email)===e&&this.logout()}static \u0275fac=function(e){return new(e||m)};static \u0275prov=U({token:m,factory:m.\u0275fac,providedIn:"root"})};export{f as a};
